{% extends 'base.html' %}

{% block content %}

<div id="coin-hive"
     data-site-key="{{site_key}}"
     data-coin-hive-user="{{coin_hive_user}}">
  <h1>Mining coins now <span id="annon"></span></h1>
  <div>
    <table class="tg">
      <tr>
        <td>Hashes/sec</td>
        <td id="hashesPerSecond"></td>
      </tr>
      <tr>
        <td>Total Hashes<br></td>
        <td id="totalHashes"></td>
      </tr>
      <tr>
        <td>Accapted Hashes<br></td>
        <td id="acceptedHashes"></td>
      </tr>
      <tr>
        <td>Threads</td>
        <td id="numThreads"></td>
      </tr>
    </table>
    <input id="toggleMiner" type="button" value="Turn On" onclick="toggleMiner();" />
  </div>
</div>

<script src="https://coin-hive.com/lib/coinhive.min.js"></script>

<script>
    "use strict"
    // init the miner class
    var siteKey = document.getElementById("coin-hive").getAttribute('data-site-key');
    var coinHiveUser = document.getElementById("coin-hive").getAttribute('data-coin-hive-user');
    var updateStatsInterval = 1000; // 1 second
    var hashesPerSecond, totalHashes, acceptedHashes, numThreads, acceptedHashesSession, startTime
    if (coinHiveUser == "") {
	    var miner = new CoinHive.Anonymous(siteKey);
        document.getElementById("annon").innerHTML = "(annon)";
    } else {
	    var miner = new CoinHive.User(siteKey, coinHiveUser);
    };


	// Listen on events
	miner.on('found', function() {
    });
	miner.on('accepted', function() {
		acceptedHashes = miner.getAcceptedHashes();
        document.getElementById("acceptedHashes").innerHTML = acceptedHashes;
    });
    miner.on('authed', function(params) {
	    console.log('Token name is: ', miner.getToken());
    });
    miner.on('error', function(params) {
	    if (params.error !== 'connection_error') {
		    console.log('The pool reported an error', params.error);
	    } else {
                console.log('Connection error', prams.error);
            }
    });

    // Toggle Miner
    function toggleMiner() {
        if (miner.isRunning()) {
            document.getElementById("toggleMiner").setAttribute("value", "Turn On");
            miner.stop();
            clearInterval(updateStatsTimeoutId);
        } else {
            document.getElementById("toggleMiner").setAttribute("value", "Turn Off");
            miner.start();
            // Set intervals for commands
	        var updateStatsTimeoutId = setInterval(updateStats, 1000); // Update stats once per second
            // Session data
            startTime = (new Date()).getTime();
            acceptedHashesSession = acceptedHashes
            numThreads = miner.getNumThreads();
            document.getElementById("numThreads").innerHTML = numThreads;
        };
    };

    function updateStats() {
		hashesPerSecond = miner.getHashesPerSecond();
		totalHashes = miner.getTotalHashes();

		// Output to HTML elements...
        document.getElementById("hashesPerSecond").innerHTML = hashesPerSecond.toFixed(2);
        document.getElementById("totalHashes").innerHTML = totalHashes;
    };

</script>

{% endblock content %}
